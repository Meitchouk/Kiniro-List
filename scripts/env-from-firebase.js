// Auto-fill Firebase Admin env vars from a service account JSON in ./firebase
// Safe: will create .env.local if missing and only overwrite the three admin vars
// Usage: npm run env:from-firebase

import fs from "fs";
import path from "path";

const root = path.join(__dirname, "..");
const envPath = path.join(root, ".env.local");
const firebaseDir = path.join(root, "firebase");

function findServiceAccount() {
    if (!fs.existsSync(firebaseDir)) return null;
    const candidates = fs
        .readdirSync(firebaseDir)
        .filter((f) => f.toLowerCase().endsWith(".json"))
        .map((f) => path.join(firebaseDir, f));
    return candidates[0] || null;
}

function loadEnvLines() {
    if (!fs.existsSync(envPath)) return [];
    return fs.readFileSync(envPath, "utf8").split(/\r?\n/);
}

function upsertEnv(lines, key, value) {
    const keyPrefix = `${key}=`;
    let replaced = false;
    const updated = lines.map((line) => {
        if (line.startsWith(keyPrefix)) {
            replaced = true;
            return `${key}=${value}`;
        }
        return line;
    });
    if (!replaced) {
        updated.push(`${key}=${value}`);
    }
    return updated;
}

function main() {
    const svcPath = findServiceAccount();
    if (!svcPath) {
        console.error("No service account JSON found in ./firebase. Place the file there and retry.");
        process.exit(1);
    }

    const raw = fs.readFileSync(svcPath, "utf8");
    let svc;
    try {
        svc = JSON.parse(raw);
    } catch (err) {
        console.error("Failed to parse service account JSON:", err.message);
        process.exit(1);
    }

    const projectId = svc.project_id;
    const clientEmail = svc.client_email;
    const privateKey = svc.private_key;

    if (!projectId || !clientEmail || !privateKey) {
        console.error("Service account JSON is missing project_id, client_email or private_key.");
        process.exit(1);
    }

    const escapedKey = privateKey.replace(/\r?\n/g, "\\n");

    let lines = loadEnvLines();
    if (lines.length === 0) {
        lines = ["# .env.local generated by scripts/env-from-firebase.js"];
    }

    lines = upsertEnv(lines, "FIREBASE_ADMIN_PROJECT_ID", projectId);
    lines = upsertEnv(lines, "FIREBASE_ADMIN_CLIENT_EMAIL", clientEmail);
    lines = upsertEnv(lines, "FIREBASE_ADMIN_PRIVATE_KEY", `"${escapedKey}"`);

    fs.writeFileSync(envPath, lines.join("\n"), "utf8");
    console.log("Updated .env.local with Firebase Admin credentials.");
    console.log("Source:", path.relative(root, svcPath));
}

main();
